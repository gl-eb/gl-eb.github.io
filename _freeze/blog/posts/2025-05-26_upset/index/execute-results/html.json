{
  "hash": "db2940e1bdfb352ad8743f11a5778545",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"UpSet Plots in the Tidyverse\"\ndescription: |\n  How to create the components of an UpSet plot and combine them\ndate: \"2025-11-02\"\nimage: plot_upset_nycf.png\nimage-alt: |\n  An UpSet plot showing which aircraft were seen at which New York City airports in 2013, as generated by the code in the blogpost\ncategories: [R, data visualisation, science]\nbibliography: references.yaml\n---\n\n\n\n## UpWhat Plot?\n\nVenn diagrams are commonly used to show the sizes of sets and their overlaps in an intuitive way.\nHowever, they can quickly become [overly complicated](https://www.nature.com/articles/nature11241#Fig4) when comparing more than a few sets.\nFor this reason, the [UpSet plot](https://upset.app/) was developed as an alternative to Venn diagrams [@lexUpSetVisualizationIntersecting2014].\nI recently needed to create UpSet plots and looked for implementations in R, of [which](https://github.com/hms-dbmi/UpSetR) [there](https://github.com/const-ae/ggupset) [are](https://github.com/gaospecial/ggVennDiagram) [many](https://jokergoo.github.io/ComplexHeatmap-reference/book/upset-plot.html).\nSome did not work as expected, others did not allow the customisation I wanted and others were unintuitive^[I am very particular when it comes to data visualisation. This does not mean they are not right for you.].\nEventually, I realised that UpSet plots are easily created using just the [`ggplot2`](https://ggplot2.tidyverse.org/) and [`patchwork`](https://patchwork.data-imaginist.com/) packages.\nThis means you do not have to learn additional packages and can just customise your UpSet plot the way you would any other standard plot.\nThus, this post is a brief tutorial on how to go from data to an UpSet plot using only tidyverse packages.\n\n## Data Wrangling\n\nFirst of all, we will set up the computational environment by loading the necessary of packages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(forcats)\nlibrary(ggplot2)\nlibrary(patchwork)\nlibrary(rlang)\nlibrary(stringr)\nlibrary(tidyr)\n\n# alternatively, you can just load the tidyverse and patchwork\n# library(tidyverse)\n# library(patchwork)\n```\n:::\n\n\nNext, we will get the raw data from the [`nycflights13`](https://nycflights13.tidyverse.org/) package and join the `nycflights13::flights` and `nycflights13::planes` tables by their tail number (think registration plate).\nThen we will determine presence and absence of aircraft types at the airports.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# import and join tables on flights and aircraft\ndat_nycf <- left_join(\n  x = nycflights13::flights,\n  y = nycflights13::planes,\n  by = join_by(tailnum)\n)\n\n# clean up data to the bare minimum\ndat_present <- dat_nycf |>\n  drop_na(manufacturer, model) |>\n  mutate(\n    aircraft = paste(str_to_title(manufacturer), model),\n    aircraft = str_replace(aircraft, \" Industrie\", \"\")\n  ) |>\n  select(\"airport\" = origin, aircraft) |>\n  distinct() |>\n  mutate(present = 1)\n\n# determine which aircraft are absent at which airports\ndat_absent <- dat_present |>\n  expand(airport, aircraft) |>\n  anti_join(dat_present, by = join_by(\"airport\", \"aircraft\")) |>\n  mutate(present = 0)\n\n# combine tables into presence/absence data\ndat_pa <- bind_rows(dat_present, dat_absent)\n\n# pivot wider\ndat_pa_w <- dat_pa |>\n  pivot_wider(id_cols = aircraft, names_from = airport, values_from = present)\ndat_pa_w\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 136 × 4\n   aircraft                              EWR   LGA   JFK\n   <chr>                               <dbl> <dbl> <dbl>\n 1 Boeing 737-824                          1     1     0\n 2 Boeing 757-223                          1     1     1\n 3 Airbus A320-232                         1     1     1\n 4 Boeing 757-232                          1     1     1\n 5 Boeing 737-924ER                        1     0     0\n 6 Canadair CL-600-2B19                    0     1     1\n 7 Boeing 757-224                          1     0     1\n 8 Mcdonnell Douglas Aircraft Co MD-88     1     1     1\n 9 Boeing 737-832                          1     1     1\n10 Airbus A319-114                         1     1     1\n# ℹ 126 more rows\n```\n\n\n:::\n:::\n\n\nAs you can see, presence of a type by `1` if it was present at an airport and `0` if it was not.\nFor example, the Boeing 737-824 was seen at the Newark and LaGuardia airports but not at JFK.\n\nNext, we will calculate the size of intersections between airports.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get vector of airports\nairports <- dat_present |>\n  pull(airport) |>\n  unique()\n\n# get airport combinations and calculate their sizes\ndat_comb_size <- dat_pa_w |>\n  count(across(-aircraft), name = \"size\") |>\n  rowwise() |>\n  mutate(\n    degree = sum(across(all_of(airports)))\n  ) |>\n  ungroup() |>\n  unite(col = combination, all_of(airports), sep = \"\", remove = FALSE) |>\n  arrange(desc(degree), desc(size)) |>\n  mutate(combination = fct_inorder(as_factor(combination)))\ndat_comb_size\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 7 × 6\n  combination   EWR   LGA   JFK  size degree\n  <fct>       <dbl> <dbl> <dbl> <int>  <dbl>\n1 111             1     1     1    30      3\n2 110             1     1     0    41      2\n3 101             1     0     1     9      2\n4 011             0     1     1     8      2\n5 001             0     0     1    22      1\n6 100             1     0     0    20      1\n7 010             0     1     0     6      1\n```\n\n\n:::\n:::\n\n\nFor example, we can see that 41 aircraft types are only seen at Newark and LaGuardia, but not at JKF.\nLet us also create a table that shows which airports are contained in each combination.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get table with presence/absence of any airport in a particular combination\ndat_comb_w <- dat_comb_size |>\n  select(combination, all_of(airports)) |>\n  pivot_longer(cols = -combination, names_to = \"set\", values_to = \"in_comb\") |>\n  mutate(set = fct_inorder(as_factor(set)))\ndat_comb_w\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 21 × 3\n   combination set   in_comb\n   <fct>       <fct>   <dbl>\n 1 111         EWR         1\n 2 111         LGA         1\n 3 111         JFK         1\n 4 110         EWR         1\n 5 110         LGA         1\n 6 110         JFK         0\n 7 101         EWR         1\n 8 101         LGA         0\n 9 101         JFK         1\n10 011         EWR         0\n# ℹ 11 more rows\n```\n\n\n:::\n:::\n\n\n## Plotting\n\nNow that the data is in shape, we can start creating the components of the UpSet plot.\nWe will set and slightly modify a global ggplot2 theme that will be applied to all plots in this document.\nWe will also define colours and other plotting parameters as variables for consistency across the individual panels of the UpSet plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# set global ggplot2 theme\ntheme_set(theme_light(base_size = 15))\n\n# update some theme components specifically for UpSet plots\ntheme_update(\n  plot.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = \"cm\"),\n  panel.border = element_blank(),\n  panel.grid = element_blank(),\n  legend.position = \"none\"\n)\n\n# assign colors from the Okabe-Ito palette to airports\nclrs_airports <- palette.colors()[c(3, 4, 8)] |> set_names(airports)\n\n# define further plotting parameters for consistency between plots\ngreys <- c(\"grey95\", \"grey75\", \"grey50\", \"grey25\", \"grey5\")\nclr_dark <- greys[4]\nclr_bg <- greys[1]\nclr_light <- greys[2]\npnt_size <- 3.5\nline_width <- 0.75\nms <- 0.25 # margin size\n\nnum_sets <- dat_comb_w |> pull(set) |> length()\nclrs_bg <- rep_len(c(clr_bg, \"white\"), ceiling(num_sets / 2))\n```\n:::\n\n\nFirst, we will plot the central matrix which encodes presence/absence of airports in each combination.\nWe use `geom_raster()` for the alternating row background colour.\nTwo separate calls to `geom_point()` are used to show presence (dark grey) and absence (light-grey).\n`geom_lines()` is used to connect presence dots to further highlight combinations.\nFurther modifications are also made to the theme of this panel.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_matrix <- dat_comb_w |>\n  filter(in_comb == 1) |>\n  ggplot(aes(x = combination, y = fct_rev(set), group = combination)) +\n  geom_raster(data = dat_comb_w, aes(fill = fct_rev(set))) +\n  geom_point(data = dat_comb_w, size = pnt_size, color = clr_light) +\n  geom_point(size = pnt_size, color = clr_dark) +\n  geom_line(linewidth = line_width, color = clr_dark) +\n  scale_fill_manual(values = clrs_bg) +\n  theme(\n    plot.background = element_rect(color = NA, fill = \"white\"),\n    axis.text.y = element_text(hjust = 0.5),\n    axis.text.x = element_blank(),\n    axis.title = element_blank(),\n    axis.ticks = element_blank(),\n    legend.position = \"none\"\n  )\nplot_matrix\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-combination-matrix-1.png){fig-align='center' width=480}\n:::\n:::\n\n\nNext, we plot the number of aircraft types in each combination using `geom_col()`.\nTo differentiate combinations with different numbers of airports (the degree of each combination) in them, we will colour the bars accordingly and sort them by descending combination degree and size.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_comb <- dat_comb_size |>\n  select(combination, size, degree) |>\n  mutate(\n    degree = degree |> as_factor() |> fct_inorder()\n  ) |>\n  ggplot(aes(\n    x = combination,\n    y = size,\n    fill = degree\n  )) +\n  geom_col(color = clr_dark) +\n  scale_y_continuous(\n    breaks = scales::breaks_pretty(),\n    expand = expansion(mult = c(0, 0.05), add = 0)\n  ) +\n  scale_fill_manual(values = greys[c(5, 3, 1)]) +\n  labs(y = \"Intersection Size\") +\n  theme(\n    plot.margin = margin(t = ms, r = ms, b = 0.2, l = 0, unit = \"cm\"),\n    axis.title.x = element_blank(),\n    axis.text.x = element_blank(),\n    axis.ticks.x = element_blank(),\n    axis.line.x = element_blank(),\n    axis.line.y = element_line(color = clr_light)\n  )\n\n# display plot with x-axis text\nplot_comb +\n  theme(\n    axis.title.x = element_text(),\n    axis.text.x = element_text()\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-combination-sizes-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nFinally, we will create a histogram showing the number of aircraft types at each airport.\nIn order to fit this panel to the combination matrix, we reverse the direction of the x-axis and move the y-axis to the right of the plot.\nWe will colour each bar representing one of the airports to differentiate this column plot from the one showing combination sizes.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_set <- dat_present |>\n  count(airport) |>\n  mutate(\n    airport = airport |> as_factor() |> fct_rev()\n  ) |>\n  ggplot(aes(x = n, y = airport, fill = airport)) +\n  geom_col(orientation = \"y\", color = clr_dark) +\n  scale_y_discrete(position = \"right\") +\n  scale_x_reverse(\n    breaks = scales::breaks_pretty(),\n    expand = expansion(mult = c(0.05, 0), add = 0)\n  ) +\n  scale_fill_manual(values = clrs_airports) +\n  labs(x = \"Aircraft\") +\n  theme(\n    plot.margin = margin(t = 0, r = 0.2, b = ms, l = ms, unit = \"cm\"),\n    axis.title.y = element_blank(),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.line.x = element_line(color = clr_light),\n    axis.line.y = element_blank()\n  )\n\n# display plot with y-axis text\nplot_set +\n  theme(\n    axis.title.y = element_text(),\n    axis.text.y = element_text()\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-set-sizes-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nLast but not least, we combine the panels into a single plot using patchwork.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# combine plots using patchwork\nplot_upset <- plot_spacer() +\n  free(plot_comb, type = \"space\", side = \"l\") +\n  plot_set +\n  plot_matrix +\n  plot_layout(\n    heights = c(1, 0.75),\n    widths = c(0.75, 1)\n  )\nplot_upset\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/patchwork-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}