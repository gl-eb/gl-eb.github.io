---
title: "UpSet Plots in the Tidyverse"
description: |
  How to create the components of an UpSet plot and combine them
date: "2025-11-02"
image: plot_upset_nycf.png
image-alt: |
  An UpSet plot showing which aircraft were seen at which New York City airports in 2013, as generated by the code in the blogpost
categories: [R, data visualisation, science]
bibliography: references.yaml
---

```{r}
#| label: lockfile
#| include: false

# use local renv lockfile
renv::use(lockfile = "renv.lock")
```

## UpWhat Plot?

Venn diagrams are commonly used to show the sizes of sets and their overlaps in an intuitive way.
However, they can quickly become [overly complicated](https://www.nature.com/articles/nature11241#Fig4) when comparing more than a few sets.
For this reason, the [UpSet plot](https://upset.app/) was developed as an alternative to Venn diagrams [@lexUpSetVisualizationIntersecting2014].
I recently needed to create UpSet plots and looked for implementations in R, of [which](https://github.com/hms-dbmi/UpSetR) [there](https://github.com/const-ae/ggupset) [are](https://github.com/gaospecial/ggVennDiagram) [many](https://jokergoo.github.io/ComplexHeatmap-reference/book/upset-plot.html).
Some were outdated but mostly they were not customisable in the ways I wanted them to be^[I am very particular when it comes to data visualisation. This does not mean they are not right for you.].
Eventually, I realised that UpSet plots are easily created using just the [`ggplot2`](https://ggplot2.tidyverse.org/) and [`patchwork`](https://patchwork.data-imaginist.com/) packages.
This means you do not have to learn additional packages and can just customise your UpSet plot the way you would any other standard ggplot.
Thus, this post is a brief tutorial on how to go from data to an UpSet plot using only tidyverse packages.

## Data Wrangling

First of all, we will load the necessary of packages.

```{r}
#| label: environment-set-up
#| output: false

library(dplyr)
library(forcats)
library(ggplot2)
library(patchwork)
library(rlang)
library(stringr)
library(tidyr)

# alternatively, you can just load the tidyverse and patchwork
# library(tidyverse)
# library(patchwork)
```

Next, we will get the raw data from the [`nycflights13`](https://nycflights13.tidyverse.org/) package and join the `flights` and `planes` tables by their tail number (think registration plate).
Then we will determine presence and absence of aircraft types at the three airports present in the data set.

```{r}
#| label: data-wrangling

# import and join tables on flights and aircraft
dat_nycf <- left_join(
  x = nycflights13::flights,
  y = nycflights13::planes,
  by = join_by(tailnum)
)

# only keep data necessary for this analysis
dat_present <- dat_nycf |>
  drop_na(manufacturer, model) |>
  mutate(
    aircraft = paste(str_to_title(manufacturer), model),
    aircraft = str_replace(aircraft, " Industrie", "")
  ) |>
  select("airport" = origin, aircraft) |>
  distinct() |>
  mutate(present = 1)

# expand aircraftâ€“airport combinations to include absence data
dat_absent <- dat_present |>
  expand(airport, aircraft) |>
  anti_join(dat_present, by = join_by("airport", "aircraft")) |>
  mutate(present = 0)

# combine tables into presence/absence data
dat_pa <- bind_rows(dat_present, dat_absent)

# pivot wider
dat_pa_w <- dat_pa |>
  pivot_wider(id_cols = aircraft, names_from = airport, values_from = present)
dat_pa_w
```

As you can see, a value of `1` indicates that a particular type was present at an airport and `0` if it was not.
For example, the Boeing 737-824 was seen at the Newark and LaGuardia airports but not at JFK.

Next, we will calculate the size of intersections between airports (i.e. how many aircraft were seen at multiple airports).

```{r}
#| label: calculate-combinations

# vector of airports
airports <- dat_present |>
  pull(airport) |>
  unique()

# get airport combinations and count the number of aircraft types within them
dat_comb_size <- dat_pa_w |>
  count(across(-aircraft), name = "size") |>
  rowwise() |>
  mutate(
    degree = sum(across(all_of(airports)))
  ) |>
  ungroup() |>
  unite(col = combination, all_of(airports), sep = "", remove = FALSE) |>
  arrange(desc(degree), desc(size)) |>
  mutate(combination = fct_inorder(as_factor(combination)))
dat_comb_size
```

For example, we can see that `r dat_comb_size |> filter(combination == "110") |> pull(size) |> as.integer()` aircraft types are only seen at Newark and LaGuardia, but not at JKF.
Now let us also create a table that shows which airports are contained in each combination.

```{r}
#| label: airport-presence-absence

# get table with presence/absence of any airport in a particular combination
dat_comb_w <- dat_comb_size |>
  select(combination, all_of(airports)) |>
  pivot_longer(cols = -combination, names_to = "set", values_to = "in_comb") |>
  mutate(set = fct_inorder(as_factor(set)))
dat_comb_w
```

## Plotting

Now that the data is in shape, we can start creating the components of the UpSet plot.
We will set and slightly modify a global ggplot2 theme that will be applied to all plots in this document.
We will also define colours and other plotting parameters as variables for consistency across the individual panels of the UpSet plot.

```{r}
#| label: plotting-set-up

# set global ggplot2 theme
theme_set(theme_light(base_size = 15))

# update some theme components specifically for UpSet plots
theme_update(
  plot.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm"),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  legend.position = "none"
)

# assign colors from the Okabe-Ito palette to airports
clrs_airports <- palette.colors()[c(3, 4, 8)] |> set_names(airports)

# define further plotting parameters for consistency between plots
greys <- c("grey95", "grey75", "grey50", "grey25", "grey5")
clr_dark <- greys[4]
clr_bg <- greys[1]
clr_light <- greys[2]
pnt_size <- 3.5
line_width <- 0.75
ms <- 0.25 # margin size

num_sets <- dat_comb_w |> pull(set) |> length()
clrs_bg <- rep_len(c(clr_bg, "white"), ceiling(num_sets / 2))
```

First, we will plot the central matrix which encodes presence/absence of airports in each combination.
We use `geom_raster()` for the alternating background colour of rows.
Two separate calls to `geom_point()` are used to show presence (dark grey) and absence (light-grey).
`geom_lines()` is used to connect presence dots to further highlight combinations.
Further modifications are also made to the theme of this panel.

```{r}
#| label: plot-combination-matrix
#| fig-align: center
#| fig.height: 2.5
#| fig.width: 5

plot_matrix <- dat_comb_w |>
  filter(in_comb == 1) |>
  ggplot(aes(x = combination, y = fct_rev(set), group = combination)) +
  geom_raster(data = dat_comb_w, aes(fill = fct_rev(set))) +
  geom_point(data = dat_comb_w, size = pnt_size, color = clr_light) +
  geom_point(size = pnt_size, color = clr_dark) +
  geom_line(linewidth = line_width, color = clr_dark) +
  scale_fill_manual(values = clrs_bg) +
  theme(
    plot.background = element_rect(color = NA, fill = "white"),
    axis.text.y = element_text(hjust = 0.5),
    axis.text.x = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "none"
  )
plot_matrix
```

Next, we plot the number of aircraft types in each combination using `geom_col()`.
To differentiate combinations with different numbers of airports in them (the degree of each combination), we will colour the bars accordingly and sort them by descending combination degree and size.

```{r}
#| label: plot-combination-sizes
#| fig-align: center
#| fig.height: 5

plot_comb <- dat_comb_size |>
  select(combination, size, degree) |>
  mutate(
    degree = degree |> as_factor() |> fct_inorder()
  ) |>
  ggplot(aes(
    x = combination,
    y = size,
    fill = degree
  )) +
  geom_col(color = clr_dark) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(),
    expand = expansion(mult = c(0, 0.05), add = 0)
  ) +
  scale_fill_manual(values = greys[c(5, 3, 1)]) +
  labs(y = "Intersection Size") +
  theme(
    plot.margin = margin(t = ms, r = ms, b = 0.2, l = 0, unit = "cm"),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(),
    axis.line.y = element_line(color = clr_light)
  )

# display plot with x-axis text
plot_comb +
  theme(
    axis.title.x = element_text(),
    axis.text.x = element_text()
  )
```

Finally, we will create a histogram showing the number of aircraft types at each airport.
In order to fit this panel to the combination matrix, we reverse the direction of the x-axis and move the y-axis to the right of the plot.
We will colour each bar representing one of the airports to differentiate this bar plot from the one showing combination sizes.

```{r}
#| label: plot-set-sizes
#| fig-align: center
#| fig.height: 3
#| fig.width: 6

plot_set <- dat_present |>
  count(airport) |>
  mutate(
    airport = airport |> as_factor() |> fct_rev()
  ) |>
  ggplot(aes(x = n, y = airport, fill = airport)) +
  geom_col(orientation = "y", color = clr_dark) +
  scale_y_discrete(position = "right") +
  scale_x_reverse(
    breaks = scales::breaks_pretty(),
    expand = expansion(mult = c(0.05, 0), add = 0)
  ) +
  scale_fill_manual(values = clrs_airports) +
  labs(x = "Aircraft") +
  theme(
    plot.margin = margin(t = 0, r = 0.2, b = ms, l = ms, unit = "cm"),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line.x = element_line(color = clr_light),
    axis.line.y = element_blank()
  )

# display plot with y-axis text
plot_set +
  theme(
    axis.title.y = element_text(),
    axis.text.y = element_text()
  )
```

Last but not least, we combine the panels into a single plot using patchwork.

```{r}
#| label: patchwork

# combine plots using patchwork
plot_upset <- plot_spacer() +
  free(plot_comb, type = "space", side = "l") +
  plot_set +
  plot_matrix +
  plot_layout(
    heights = c(1, 0.75),
    widths = c(0.75, 1)
  )
```

```{r}
#| label: export-upset
#| eval: true
#| include: false

ggsave(
  filename = "plot_upset_nycf.png",
  plot = plot_upset,
  device = ragg::agg_png,
  height = 10,
  width = 12,
  units = "cm"
)
```

## Conclusions

```{r}
#| label: display-upset
#| echo: false
#| fig-align: center
#| fig.height: 5.5
#| fig.width: 8

plot_upset
```

Now that we created an UpSet plot, we can start drawing conclusions from the data.
In this case we computed non-distinct combinations, meaning that any particular aircraft type might be in multiple combinations.
As you can see, while LaGuardia Airport has the fewest unique aircraft types, it is part of the biggest combination containing `r dat_comb_size |> filter(combination == "110") |> pull(size) |> as.integer()` types observed at both LaGuardia and Newark Liberty International Airport.
The combination including all three airports is smaller at `r dat_comb_size |> filter(combination == "111") |> pull(size) |> as.integer()` types.
We can thus conclude that while John F. Kennedy International Airport shares `r dat_comb_size |> filter(combination == "111") |> pull(size) |> as.integer()` types with the other two airports, it is the most different airport in terms of aircraft types out of the three analysed here.
This conclusion is also supported by the fact that it was the highest number of types that do not occur at other airports at `r dat_comb_size |> filter(combination == "001") |> pull(size) |> as.integer()` types (though Newark is a close second).
